//压缩并混淆后的代码
let userID='90cd4a77-141a-43c9-991b-08263cfe9c10',proxyIP='',sub='',subconverter='SUBAPI.fxxk.dedyn.io',subconfig="https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/config/ACL4SSR_Online_Mini_MultiMode.ini",subProtocol='https',socks5Address='',parsedSocks5Address={},enableSocks=false,fakeUserID,fakeHostName,noTLS='false',expire=4102329600,proxyIPs,socks5s,go2Socks5s=['*ttvnw.net','*tapecontent.net','*cloudatacdn.com','*.loadshare.org'],addresses=[],addressesapi=[],addressesnotls=[],addressesnotlsapi=[],addressescsv=[],DLS=8,FileName='edgetunnel',BotToken='',ChatID='',proxyhosts=[],proxyhostsURL='https://raw.githubusercontent.com/cmliu/CFcdnVmess2sub/main/proxyhosts',RproxyIP='false',httpsPorts=["2053","2083","2087","2096","8443"],effectiveTime=7,updateTime=3,userIDLow,userIDTime="";if(!isValidUUID(userID)){throw new Error('uuid is not valid');}export default{async fetch(request,env,ctx){try{const UA=request.headers.get('User-Agent')||'null',userAgent=UA.toLowerCase();userID=(env.UUID||userID).toLowerCase();const currentDate=new Date();currentDate.setHours(0,0,0,0);const timestamp=Math.ceil(currentDate.getTime()/1000),fakeUserIDMD5=await MD5MD5(`${userID}${timestamp}`);fakeUserID=fakeUserIDMD5.slice(0,8)+"-"+fakeUserIDMD5.slice(8,12)+"-"+fakeUserIDMD5.slice(12,16)+"-"+fakeUserIDMD5.slice(16,20)+"-"+fakeUserIDMD5.slice(20);fakeHostName=fakeUserIDMD5.slice(6,9)+"."+fakeUserIDMD5.slice(13,19);if(env.KEY){const userIDs=await generateDynamicUUID(env.KEY);userID=userIDs[0];userIDLow=userIDs[1];userIDTime=userIDs[2];effectiveTime=env.TIME||effectiveTime;updateTime=env.UPTIME||updateTime;}proxyIP=env.PROXYIP||proxyIP;proxyIPs=await ADD(proxyIP);proxyIP=proxyIPs[Math.floor(Math.random()*proxyIPs.length)];socks5Address=env.SOCKS5||socks5Address;socks5s=await ADD(socks5Address);socks5Address=socks5s[Math.floor(Math.random()*socks5s.length)];socks5Address=socks5Address.split('//')[1]||socks5Address;if(env.CFPORTS)httpsPorts=await ADD(env.CFPORTS);sub=env.SUB||sub;subconverter=env.SUBAPI||subconverter;if(subconverter.includes("http://")){subconverter=subconverter.split("//")[1];subProtocol='http';}else{subconverter=subconverter.split("//")[1]||subconverter;}subconfig=env.SUBCONFIG||subconfig;if(socks5Address){try{parsedSocks5Address=socks5AddressParser(socks5Address);RproxyIP=env.RPROXYIP||'false';enableSocks=true;}catch(err){let e=err;console.log(e.toString());RproxyIP=env.RPROXYIP||!proxyIP?'true':'false';enableSocks=false;}}else{RproxyIP=env.RPROXYIP||!proxyIP?'true':'false';}if(env.ADD)addresses=await ADD(env.ADD);if(env.ADDAPI)addressesapi=await ADD(env.ADDAPI);if(env.ADDNOTLS)addressesnotls=await ADD(env.ADDNOTLS);if(env.ADDNOTLSAPI)addressesnotlsapi=await ADD(env.ADDNOTLSAPI);if(env.ADDCSV)addressescsv=await ADD(env.ADDCSV);DLS=env.DLS||DLS;BotToken=env.TGTOKEN||BotToken;ChatID=env.TGID||ChatID;if(env.GO2SOCKS5)go2Socks5s=await ADD(env.GO2SOCKS5);const upgradeHeader=request.headers.get('Upgrade'),url=new URL(request.url);if(url.searchParams.has('sub')&&url.searchParams.get('sub')!=='')sub=url.searchParams.get('sub');FileName=env.SUBNAME||FileName;if(url.searchParams.has('notls'))noTLS='true';if(!upgradeHeader||upgradeHeader!=='websocket'){const 路径=url.pathname.toLowerCase();if(路径=='/'){if(env.URL302)return Response.redirect(env.URL302,302);else if(env.URL)return await proxyURL(env.URL,url);else return new Response(JSON.stringify(request.cf,null,4),{status:200,headers:{'content-type':'application/json',},});}else if(路径==`/${fakeUserID}`){const fakeConfig=await getVLESSConfig(userID,request.headers.get('Host'),sub,'CF-Workers-SUB',RproxyIP,url,env);return new Response(`${fakeConfig}`,{status:200});}else if(路径==`/${env.KEY}`||路径==`/${userID}`){await sendMessage(`#获取订阅 ${FileName}`,request.headers.get('CF-Connecting-IP'),`UA: ${UA}</tg-spoiler>\n域名: ${url.hostname}\n<tg-spoiler>入口: ${url.pathname+url.search}</tg-spoiler>`);const vlessConfig=await getVLESSConfig(userID,request.headers.get('Host'),sub,UA,RproxyIP,url,env),now=Date.now(),today=new Date(now);today.setHours(0,0,0,0);const UD=Math.floor(((now-today.getTime())/86400000)*24*1099511627776/2),pagesSum=UD,workersSum=UD,total=24*1099511627776;if(env.CFEMAIL&&env.CFKEY){const email=env.CFEMAIL,key=env.CFKEY,accountIndex=env.CFID||0,accountId=await getAccountId(email,key);if(accountId){const now=new Date();now.setUTCHours(0,0,0,0);const startDate=now.toISOString(),endDate=new Date().toISOString(),Sum=await getSum(accountId,accountIndex,email,key,startDate,endDate);pagesSum=Sum[0];workersSum=Sum[1];total=102400;}}if(userAgent&&userAgent.includes('mozilla')){return new Response(`${vlessConfig}`,{status:200,headers:{"Content-Type":"text/plain;charset=utf-8","Profile-Update-Interval":"6","Subscription-Userinfo":`upload=${pagesSum}; download=${workersSum}; total=${total}; expire=${expire}`,}});}else{return new Response(`${vlessConfig}`,{status:200,headers:{"Content-Disposition":`attachment; filename=${FileName}; filename*=utf-8''${encodeURIComponent(FileName)}`,"Content-Type":"text/plain;charset=utf-8","Profile-Update-Interval":"6","Subscription-Userinfo":`upload=${pagesSum}; download=${workersSum}; total=${total}; expire=${expire}`,}});}}else{if(env.URL302)return Response.redirect(env.URL302,302);else if(env.URL)return await proxyURL(env.URL,url);else return new Response('不用怀疑！你UUID就是错的！！！',{status:404});}}else{proxyIP=url.searchParams.get('proxyip')||proxyIP;if(new RegExp('/proxyip=','i').test(url.pathname))proxyIP=url.pathname.toLowerCase().split('/proxyip=')[1];else if(new RegExp('/proxyip.','i').test(url.pathname))proxyIP=`proxyip.${url.pathname.toLowerCase().split("/proxyip.")[1]}`;socks5Address=url.searchParams.get('socks5')||socks5Address;if(new RegExp('/socks5=','i').test(url.pathname))socks5Address=url.pathname.split('5=')[1];else if(new RegExp('/socks://','i').test(url.pathname)||new RegExp('/socks5://','i').test(url.pathname)){socks5Address=url.pathname.split('://')[1].split('#')[0];if(socks5Address.includes('@')){let userPassword=socks5Address.split('@')[0];const base64Regex=/^(?:[A-Z0-9+/]{4})*(?:[A-Z0-9+/]{2}==|[A-Z0-9+/]{3}=)?$/i;if(base64Regex.test(userPassword)&&!userPassword.includes(':'))userPassword=atob(userPassword);socks5Address=`${userPassword}@${socks5Address.split('@')[1]}`;}}if(socks5Address){try{parsedSocks5Address=socks5AddressParser(socks5Address);enableSocks=true;}catch(err){let e=err;console.log(e.toString());enableSocks=false;}}else{enableSocks=false;}return await vlessOverWSHandler(request);}}catch(err){let e=err;return new Response(e.toString());}},};async function vlessOverWSHandler(request){const webSocketPair=new WebSocketPair(),[client,webSocket]=Object.values(webSocketPair);webSocket.accept();let address='',portWithRandomLog='',log=(info,event)=>{console.log(`[${address}:${portWithRandomLog}] ${info}`,event||'');},earlyDataHeader=request.headers.get('sec-websocket-protocol')||'',readableWebSocketStream=makeReadableWebSocketStream(webSocket,earlyDataHeader,log),remoteSocketWapper={value:null},isDns=false;readableWebSocketStream.pipeTo(new WritableStream({async write(chunk,controller){if(isDns)return await handleDNSQuery(chunk,webSocket,null,log);if(remoteSocketWapper.value){const writer=remoteSocketWapper.value.writable.getWriter();await writer.write(chunk);writer.releaseLock();return;}const{hasError,message,addressType,portRemote=443,addressRemote='',rawDataIndex,vlessVersion=new Uint8Array([0,0]),isUDP}=processVlessHeader(chunk,userID);address=addressRemote;portWithRandomLog=`${portRemote}--${Math.random()} ${isUDP?'udp ':'tcp '}`;if(hasError)throw new Error(message);if(isUDP){if(portRemote===53)isDns=true;else throw new Error('UDP 代理仅对 DNS（53 端口）启用');}const vlessResponseHeader=new Uint8Array([vlessVersion[0],0]),rawClientData=chunk.slice(rawDataIndex);if(isDns)return handleDNSQuery(rawClientData,webSocket,vlessResponseHeader,log);log(`处理 TCP 出站连接 ${addressRemote}:${portRemote}`);handleTCPOutBound(remoteSocketWapper,addressType,addressRemote,portRemote,rawClientData,webSocket,vlessResponseHeader,log);},close(){log(`readableWebSocketStream 已关闭`);},abort(reason){log(`readableWebSocketStream 已中止`,JSON.stringify(reason));}})).catch(err=>{log('readableWebSocketStream 管道错误',err);});return new Response(null,{status:101,webSocket:client});}function base64ToArrayBuffer(base64Str){if(!base64Str)return{error:null};try{base64Str=base64Str.replace(/-/g,'+').replace(/_/g,'/');const decode=atob(base64Str),arryBuffer=Uint8Array.from(decode,c=>c.charCodeAt(0));return{earlyData:arryBuffer.buffer,error:null};}catch(error){return{error};}}function isValidUUID(uuid){const uuidRegex=/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;return uuidRegex.test(uuid);}function safeCloseWebSocket(socket){try{if(socket.readyState===1||socket.readyState===2)socket.close();}catch(error){console.error('safeCloseWebSocket error',error);}}async function MD5MD5(text){const encoder=new TextEncoder(),firstPass=await crypto.subtle.digest('MD5',encoder.encode(text)),firstPassArray=Array.from(new Uint8Array(firstPass)),firstHex=firstPassArray.map(b=>b.toString(16).padStart(2,'0')).join('');const secondPass=await crypto.subtle.digest('MD5',encoder.encode(firstHex.slice(7,27))),secondPassArray=Array.from(new Uint8Array(secondPass)),secondHex=secondPassArray.map(b=>b.toString(16).padStart(2,'0')).join('');return secondHex.toLowerCase();}async function ADD(envadd){var addtext=envadd.replace(/[	|"'\r\n]+/g,',').replace(/,+/g,',');if(addtext.charAt(0)==',')addtext=addtext.slice(1);if(addtext.charAt(addtext.length-1)==',')addtext=addtext.slice(0,addtext.length-1);return addtext.split(',');}async function proxyURL(proxyURL,url){const URLs=await ADD(proxyURL),fullURL=URLs[Math.floor(Math.random()*URLs.length)];let parsedURL=new URL(fullURL);let URLProtocol=parsedURL.protocol.slice(0,-1)||'https',URLHostname=parsedURL.hostname,URLPathname=parsedURL.pathname,URLSearch=parsedURL.search;if(URLPathname.charAt(URLPathname.length-1)=='/')URLPathname=URLPathname.slice(0,-1);URLPathname+=url.pathname;let newURL=`${URLProtocol}://${URLHostname}${URLPathname}${URLSearch}`,response=await fetch(newURL),newResponse=new Response(response.body,{status:response.status,statusText:response.statusText,headers:response.headers});newResponse.headers.set('X-New-URL',newURL);return newResponse;}function checkSUB(host){if((!sub||sub=='')&&(addresses.length+addressesapi.length+addressesnotls.length+addressesnotlsapi.length+addressescsv.length)==0){addresses=['Join.my.Telegram.channel.CMLiussss.to.unlock.more.premium.nodes.cf.090227.xyz#加入我的频道t.me/CMLiussss解锁更多优选节点','127.0.0.1:1234#CFnat','visa.cn:443','singapore.com:8443','japan.com:2053','brazil.com:2083','russia.com:2087','www.gov.ua:2096','www.gco.gov.qa:8443','www.gov.se','time.is','www.wto.org:8443','fbi.gov:2087','icook.hk','[2606:4700::]#IPv6'];if(host.includes(".workers.dev"))addressesnotls=['usa.visa.com:2095','myanmar.visa.com:8080','dynadot.com:8880','www.visaeurope.ch:2052','shopify.com:2082','www.visasoutheasteurope.com:2086'];}}const 啥啥啥_写的这是啥啊=`\u0064\u006d\u0078\u006c\u0063\u0033\u004d\u003d`;function 配置信息(UUID,域名地址){const 协议类型=atob(啥啥啥_写的这是啥啊),别名=FileName;let 地址=域名地址,端口=443,用户ID=UUID,加密方式='none',传输层协议='ws',伪装域名=域名地址,路径='/?ed=2560',传输层安全=['tls',true],SNI=域名地址,指纹='randomized';if(域名地址.includes('.workers.dev')){地址='visa.cn';端口=80;传输层安全=['',false];}const v2ray=`${协议类型}://${用户ID}@${地址}:${端口}\u003f\u0065\u006e\u0063\u0072\u0079\u0070\u0074\u0069\u006f\u006e\u003d${加密方式}&security=${传输层安全[0]}&sni=${SNI}&fp=${指纹}&type=${传输层协议}&host=${伪装域名}&path=${encodeURIComponent(路径)}#${encodeURIComponent(别名)}`,clash=`- type: ${协议类型}\n  name: ${FileName}\n  server: ${地址}\n  port: ${端口}\n  uuid: ${用户ID}\n  network: ${传输层协议}\n  tls: ${传输层安全[1]}\n  udp: false\n  sni: ${SNI}\n  client-fingerprint: ${指纹}\n  ws-opts:\n    path: "${路径}"\n    headers:\n      host: ${伪装域名}`;return[v2ray,clash];}let subParams=['sub','base64','b64','clash','singbox','sb'];
